import binascii
import random

import libnum
import rsa


def gcd(a, b):
    if a < b:
        a, b = b, a
    while b != 0:
        temp = a % b
        a = b
        b = temp
    return a


def getpq(n, e, d):
    p = 1
    q = 1
    while p == 1 and q == 1:
        k = d * e - 1
        g = random.randint(0, n)
        while p == 1 and q == 1 and k % 2 == 0:
            k = int(k / 2)
            y = pow(g, k, n)
            if y != 1 and gcd(y - 1, n) > 1:
                p = gcd(y - 1, n)
                q = n / p
    return int(p), int(q)


def egcd(a, b):
    if a == 0:
        return b, 0, 1
    else:
        g, y, x = egcd(b % a, a)
        return g, x - (b // a) * y, y


def invmod(a, m):
    g, x, y = egcd(a, m)
    if g != 1:
        raise Exception('modular inverse does not exist')
    else:
        return x % m


def fast_pow_mod(b, e, m):
    result = 1
    while e != 0:
        if (e & 1) == 1:
            result = (result * b) % m
        e >>= 1
        b = (b * b) % m
    return result


def de_rsa_str(c, p, q, e, n):
    return binascii.a2b_hex(hex(de_rsa_num(c, p, q, e, n))[2:])


def de_rsa_num(c, p, q, e, n):
    d = rsa_d(e, p, q)
    m = fast_pow_mod(c, d, n)
    return m


def rsa_file(path, p, q, e, n):
    d = rsa_d(e, p, q)
    key = rsa.PrivateKey(n, e, d, p, q)
    with open(path, 'rb') as flag:
        m = rsa.decrypt(flag.read(), key).decode()
    return m


def rsa_d(e, p, q):
    return libnum.invmod(e, (p - 1) * (q - 1))


# def de_rsa_same_mod(n, c1, c2, e1, e2):
#     s = egcd(e1, e2)
#     s1 = s[1]
#     s2 = s[2]
#     if s1 < 0:
#         s1 = - s1
#         c1 = invert(c1, n)
#     elif s2 < 0:
#         s2 = - s2
#         c2 = invert(c2, n)
#     m = pow(c1, s1, n) * pow(c2, s2, n) % n
#     return m


if __name__ == '__main__':
    n = 322831561921859
    p = 13574881
    q = 23781539
    e = 23
    c = 242094131279916
    m = de_rsa_str(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

    n = 86934482296048119190666062003494800588905656017203025617216654058378322103517
    p = 285960468890451637935629440372639283459
    q = 304008741604601924494328155975272418463
    e = 65537
    c = '../temp/flag.enc'
    m = rsa_file(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

    n = 966808932627497190635859236054960349099463975227350564265384373280336699853387254070662881265937565163000758606154308757944030571837175048514574473061401566330836334647176655282619268592560172726526643074499534129878217409046045533656897050117438496357231575999185527675071002803951800635220029015932007465117818739948903750200830856115668691007706836952244842719419452946259275251773298338162389930518838272704908887016474007051397194588396039111216708866214614779627566959335170676055025850932631053641576566165694121420546081043285806783239296799795655191121966377590175780618944910532816988143056757054052679968538901460893571204904394975714081055455240523895653305315517745729334114549756695334171142876080477105070409544777981602152762154610738540163796164295222810243309051503090866674634440359226192530724635477051576515179864461174911975667162597286769079380660782647952944808596310476973939156187472076952935728249061137481887589103973591082872988641958270285169650803792395556363304056290077801453980822097583574309682935697260204862756923865556397686696854239564541407185709940107806536773160263764483443859425726953142964148216209968437587044617613518058779287167853349364533716458676066734216877566181514607693882375533
    p = 0xf64ef16d60d35615c4b78ff2f2c6625cc58294398c4658a2f5cb1214ca497a61046ec17984d7ce46dd3cd7e2242c5486c62b6b5184e85531aa54eacf48b0cc4df792867b3d50ad056dc739e567f45465c81d808adfadc1b7d3a6dfe04c7f8aec9a595f04615ba21762d7225bd462ab9afbf57008e5dbfc61aaaa9e44b848ee25e5a7a0a823bc92718739d830b1f21942f7bf68e702fa4afe2cccd6cfb0c11342deca75c3c0ca8f9f4993a91310dc42819dfe702738dba4d85f6b585efe9ff1b2a912fee1cf61620fda877a547858e3e9d9138f1a05b4c75e43407267205f47657f2a56bfca1b3b1e05a1a22ff7e6f3c01bdb85e297abe63b6253446b63c2f0e9
    q = 0xf64ef16d60d35615c4b78ff2f2c6625cc58294398c4658a2f5cb1214ca497a61046ec17984d7ce46dd3cd7e2242c5486c62b6b5184e85531aa54eacf48b0cc4df792867b3d50ad056dc739e567f45465c81d808adfadc1b7d3a6dfe04c7f8aec9a595f04615ba21762d7225bd462ab9afbf57008e5dbfc61aaaa9e44b848ee25e5a7a0a823bc92718739d830b1f21942f7bf68e702fa4afe2cccd6cfb0c11342deca75c3c0ca8f9f4993a91310dc42819dfe702738dba4d85f6b585efe9ff1b2a912fee1cf61620fda877a547858e3e9d9138f1a05b4c75e43407267205f47657f2a56bfca1b3b1e05a1a22ff7e6f3c01bdb85e297abe63b6253446b6fb535e5
    e = 65537
    c = 168502910088858295634315070244377409556567637139736308082186369003227771936407321783557795624279162162305200436446903976385948677897665466290852769877562167487142385308027341639816401055081820497002018908896202860342391029082581621987305533097386652183849657065952062433988387640990383623264405525144003500286531262674315900537001845043225363148359766771033899680111076181672797077410584747509581932045540801777738548872747597899965366950827505529432483779821158152928899947837196391555666165486441878183288008753561108995715961920472927844877569855940505148843530998878113722830427807926679324241141182238903567682042410145345551889442158895157875798990903715105782682083886461661307063583447696168828687126956147955886493383805513557604179029050981678755054945607866353195793654108403939242723861651919152369923904002966873994811826391080318146260416978499377182540684409790357257490816203138499369634490897553227763563553981246891677613446390134477832143175248992161641698011195968792105201847976082322786623390242470226740685822218140263182024226228692159380557661591633072091945077334191987860262448385123599459647228562137369178069072804498049463136233856337817385977990145571042231795332995523988174895432819872832170029690848
    m = de_rsa_str(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

    e = 0x1d2d2f1f173f81cf368fec06d40d47fd92f8615c12eec14168f288427952b8cf5a538f70ba3341b6a173ae80375a96b0d384d9722b19149f78947375e0a33df5e693edabd5e4d44cffa9e525ea014f3fa499b5f7b29b219d90b88da55aae3a08637338d7bed056e3aec575be56bbde534b355a2e7757db7aeca96e78d67f21530b7c3ec24ac61f9b474ab283220dd9545135d065a724ce2f8f44e32e460eef5f9958009c58af595193d77e72c25f0cb01505b993c135328b11b500dcabc955c9177f839dd043586e25a31335e7d5437dc9e6cd6d4ebecb2937e16026c2792e1745f44eed5411beaab55ed0905db9198cbd431111be87462f46369e31d1a4613f
    n = 0xC20745223FF5B94B2CD8412166F7288A21F2187E1A421453918CAB03C80253451233EB1BDC2363744228AA8694A8C2CBC833F80DDF40831A68901B230B83F3F0FED4B72D0B942B5E95DEDAC8DCC0047A2AFB90C81ED72D3AD49B72FC8BD0D3167DDDAA6AB5167C058DF36AF190B216085BBD9D621F9BD23A093E4E3D9CC387B6274F2C339C88E1B2D908ACB33F4E20E647ABEE0714A3CCE4646E896294B78103DCC9A4DB7ED681164C6E6CC7FD33476E174A6C707037B250491365F9F0EB76AEABA07DB2F662D88048AF98C88C76C6710DB9658D49FCA0CAF1F5CD99DC07F188432B48F85571168AD10FC824B7B682BAD6CAA5D12FF6F04C92786B738AB19BB7
    d = 1779217788383673416690068487595062922771414230914791138743960472798057054853883175313487137767631446949382388070798609545617543049566741624609996040273727
    p = 149604112324264915811376746906108325951188179904814259006959765070266946659481820938211689946210254302179197289522748397160602946376246768419310765669852537378426700376878745285639531531077237124655345323906476180103106894642043615024716862503414785057646920410083538192951872861366496901158348770066798098371
    q = 163724217068973025857079545677048587508164102644298632911494474022224582218067057349189211462632427829087720476013052665037199232658015194718500750961261016558605363103092187533086949903145449057015220561698195502163792192055762108803714387175594231859738263839090338762578040513451585421537323416472060788989
    u = 46945771488564725732882395880244713201331050076764192356141976972850199648928915704938972020118498373551560154884981762756751705017013721038985876847070192139187402648840734808286722405249511866249460654114019194160905675696275576470150706691370426828684785556902563498825216430847729380773761134440167374244

    print(n == p * q)
    print(d == rsa_d(e, p, q))
    print(invmod(p, q))

