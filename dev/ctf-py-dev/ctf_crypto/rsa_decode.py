import random
import binascii
import libnum
import rsa


def gcd(a, b):
    if a < b:
        a, b = b, a
    while b != 0:
        temp = a % b
        a = b
        b = temp
    return a


def getpq(n, e, d):
    p = 1
    q = 1
    while p == 1 and q == 1:
        k = d * e - 1
        g = random.randint(0, n)
        while p == 1 and q == 1 and k % 2 == 0:
            k = int(k / 2)
            y = pow(g, k, n)
            if y != 1 and gcd(y - 1, n) > 1:
                p = gcd(y - 1, n)
                q = n / p
    return int(p), int(q)


def egcd(a, b):
    if a == 0:
        return b, 0, 1
    else:
        g, y, x = egcd(b % a, a)
        return g, x - (b // a) * y, y


def invmod(a, m):
    g, x, y = egcd(a, m)
    if g != 1:
        raise Exception('modular inverse does not exist')
    else:
        return x % m


def fast_pow_mod(b, e, m):
    result = 1
    while e != 0:
        if (e & 1) == 1:
            result = (result * b) % m
        e >>= 1
        b = (b * b) % m
    return result


def de_rsa_str(c, p, q, e, n):
    return binascii.a2b_hex(hex(de_rsa_num(c, p, q, e, n))[2:])


def de_rsa_num(c, p, q, e, n):
    d = rsa_d(e, p, q)
    m = fast_pow_mod(c, d, n)
    return m


def rsa_file(path, p, q, e, n):
    d = rsa_d(e, p, q)
    key = rsa.PrivateKey(n, e, d, p, q)
    with open(path, 'rb') as flag:
        m = rsa.decrypt(flag.read(), key).decode()
    return m


def rsa_d(e, p, q):
    return libnum.invmod(e, (p - 1) * (q - 1))


# def de_rsa_same_mod(n, c1, c2, e1, e2):
#     s = egcd(e1, e2)
#     s1 = s[1]
#     s2 = s[2]
#     if s1 < 0:
#         s1 = - s1
#         c1 = invert(c1, n)
#     elif s2 < 0:
#         s2 = - s2
#         c2 = invert(c2, n)
#     m = pow(c1, s1, n) * pow(c2, s2, n) % n
#     return m


if __name__ == '__main__':
    n = 322831561921859
    p = 13574881
    q = 23781539
    e = 23
    c = 242094131279916
    m = de_rsa_str(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

    n = 86934482296048119190666062003494800588905656017203025617216654058378322103517
    p = 285960468890451637935629440372639283459
    q = 304008741604601924494328155975272418463
    e = 65537
    c = '../temp/flag.enc'
    m = rsa_file(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

    n = 966808932627497190635859236054960349099463975227350564265384373280336699853387254070662881265937565163000758606154308757944030571837175048514574473061401566330836334647176655282619268592560172726526643074499534129878217409046045533656897050117438496357231575999185527675071002803951800635220029015932007465117818739948903750200830856115668691007706836952244842719419452946259275251773298338162389930518838272704908887016474007051397194588396039111216708866214614779627566959335170676055025850932631053641576566165694121420546081043285806783239296799795655191121966377590175780618944910532816988143056757054052679968538901460893571204904394975714081055455240523895653305315517745729334114549756695334171142876080477105070409544777981602152762154610738540163796164295222810243309051503090866674634440359226192530724635477051576515179864461174911975667162597286769079380660782647952944808596310476973939156187472076952935728249061137481887589103973591082872988641958270285169650803792395556363304056290077801453980822097583574309682935697260204862756923865556397686696854239564541407185709940107806536773160263764483443859425726953142964148216209968437587044617613518058779287167853349364533716458676066734216877566181514607693882375533
    p = 0xf64ef16d60d35615c4b78ff2f2c6625cc58294398c4658a2f5cb1214ca497a61046ec17984d7ce46dd3cd7e2242c5486c62b6b5184e85531aa54eacf48b0cc4df792867b3d50ad056dc739e567f45465c81d808adfadc1b7d3a6dfe04c7f8aec9a595f04615ba21762d7225bd462ab9afbf57008e5dbfc61aaaa9e44b848ee25e5a7a0a823bc92718739d830b1f21942f7bf68e702fa4afe2cccd6cfb0c11342deca75c3c0ca8f9f4993a91310dc42819dfe702738dba4d85f6b585efe9ff1b2a912fee1cf61620fda877a547858e3e9d9138f1a05b4c75e43407267205f47657f2a56bfca1b3b1e05a1a22ff7e6f3c01bdb85e297abe63b6253446b63c2f0e9
    q = 0xf64ef16d60d35615c4b78ff2f2c6625cc58294398c4658a2f5cb1214ca497a61046ec17984d7ce46dd3cd7e2242c5486c62b6b5184e85531aa54eacf48b0cc4df792867b3d50ad056dc739e567f45465c81d808adfadc1b7d3a6dfe04c7f8aec9a595f04615ba21762d7225bd462ab9afbf57008e5dbfc61aaaa9e44b848ee25e5a7a0a823bc92718739d830b1f21942f7bf68e702fa4afe2cccd6cfb0c11342deca75c3c0ca8f9f4993a91310dc42819dfe702738dba4d85f6b585efe9ff1b2a912fee1cf61620fda877a547858e3e9d9138f1a05b4c75e43407267205f47657f2a56bfca1b3b1e05a1a22ff7e6f3c01bdb85e297abe63b6253446b6fb535e5
    e = 65537
    c = 168502910088858295634315070244377409556567637139736308082186369003227771936407321783557795624279162162305200436446903976385948677897665466290852769877562167487142385308027341639816401055081820497002018908896202860342391029082581621987305533097386652183849657065952062433988387640990383623264405525144003500286531262674315900537001845043225363148359766771033899680111076181672797077410584747509581932045540801777738548872747597899965366950827505529432483779821158152928899947837196391555666165486441878183288008753561108995715961920472927844877569855940505148843530998878113722830427807926679324241141182238903567682042410145345551889442158895157875798990903715105782682083886461661307063583447696168828687126956147955886493383805513557604179029050981678755054945607866353195793654108403939242723861651919152369923904002966873994811826391080318146260416978499377182540684409790357257490816203138499369634490897553227763563553981246891677613446390134477832143175248992161641698011195968792105201847976082322786623390242470226740685822218140263182024226228692159380557661591633072091945077334191987860262448385123599459647228562137369178069072804498049463136233856337817385977990145571042231795332995523988174895432819872832170029690848
    m = de_rsa_str(c, p, q, e, n)
    print(m)

    del n, p, e, c, m

